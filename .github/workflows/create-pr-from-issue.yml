name: Create PR from Issue

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  add-domain:
    if: contains(github.event.issue.labels.*.name, 'add-domain')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Extract domain from issue
        id: extract
        run: |
          DOMAIN=$(echo "${{ github.event.issue.body }}" | grep -Eo '([a-z0-9.-]+\.[a-z]{2,})' | head -n1 | tr '[:upper:]' '[:lower:]')
          echo "Domain found: $DOMAIN"
          echo "domain=$DOMAIN" >> $GITHUB_OUTPUT

      - name: Check if domain already exists
        id: exists
        run: |
          DOMAIN="${{ steps.extract.outputs.domain }}"
          if jq --arg d "$DOMAIN" 'index($d)' list.json | grep -qv null; then
            echo "Domain already exists"
            gh issue comment ${{ github.event.issue.number }} --body "❌ \`$DOMAIN\` already exists in the list."
            gh issue close ${{ github.event.issue.number }}
            exit 0
          fi

      - name: Add and sort domain in list.json
        run: |
          DOMAIN="${{ steps.extract.outputs.domain }}"
          jq --arg d "$DOMAIN" '. + [$d] | sort' list.json > list.json.tmp && mv list.json.tmp list.json

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          BRANCH="add-domain-${{ github.event.issue.number }}"
          git checkout -b $BRANCH
          git add list.json
          git commit -m "Add ${{ steps.extract.outputs.domain }} from issue #${{ github.event.issue.number }}"
          git push --force origin $BRANCH
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create pull request
        run: |
          gh pr create \
            --title "Add ${{ steps.extract.outputs.domain }}" \
            --body "Closes #${{ github.event.issue.number }}" \
            --base main \
            --head "add-domain-${{ github.event.issue.number }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}